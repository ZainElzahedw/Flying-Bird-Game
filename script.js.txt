
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const scoreDiv = document.getElementById("score");
const restartBtn = document.getElementById("restart");
const flySound = document.getElementById("flySound");
const hitSound = document.getElementById("hitSound");

const storeBtn = document.getElementById("storeBtn");
const storeDiv = document.getElementById("store");
const closeStoreBtn = document.getElementById("closeStore");
const charactersDiv = document.getElementById("characters");

const startScreen = document.getElementById("startScreen");
const playBtn = document.getElementById("playBtn");
const gameUI = document.getElementById("gameUI");

// الشخصيات المتاحة
const characterList = [
  {name:"Yellow", src:"https://i.imgur.com/nM7iqCQ.png", price:0, unlockLevel:1},
  {name:"Red", src:"https://i.imgur.com/91qIQJt.png", price:100, unlockLevel:1},
  {name:"Blue", src:"https://i.imgur.com/q7tJ3kJ.png", price:150, unlockLevel:5},
  {name:"Green", src:"https://i.imgur.com/5F7kJvV.png", price:200, unlockLevel:10}
];

let birdImg = new Image();
birdImg.src = characterList[0].src; // الشخصية الافتراضية

const pipeTopImg = new Image();
pipeTopImg.src = "https://i.imgur.com/zxFtjzZ.png";

const pipeBottomImg = new Image();
pipeBottomImg.src = "https://i.imgur.com/HTI9IhQ.png";

let bird, pipes, frame;
let score, coins, level;
let gameOver;

// الصعوبة
let pipeSpeed;
let pipeGap;

function init() {
  bird = { x: 80, y: 200, width: 34, height: 24, velocity: 0, gravity: 0.6, lift: -10 };
  pipes = [];
  frame = 0;
  score = 0;
  coins = 0;
  level = 1;
  gameOver = false;
  pipeSpeed = 2;
  pipeGap = 160;
  updateScore();
  renderStore();
}

function updateScore() {
  scoreDiv.innerText = `Score: ${score} | Coins: ${coins} | Level: ${level}`;
}

function drawBird() { ctx.drawImage(birdImg, bird.x, bird.y, bird.width, bird.height); }
function updateBird() {
  bird.velocity += bird.gravity;
  bird.y += bird.velocity;
  if (bird.y + bird.height > canvas.height || bird.y < 0) endGame();
}

function createPipe() {
  let top = Math.random() * 250 + 40;
  pipes.push({ x: canvas.width, top: top, bottom: canvas.height - top - pipeGap, width: 60, passed: false });
}

function drawPipes() {
  pipes.forEach(p => {
    ctx.drawImage(pipeTopImg, p.x, 0, p.width, p.top);
    ctx.drawImage(pipeBottomImg, p.x, canvas.height - p.bottom, p.width, p.bottom);
  });
}

function updatePipes() {
  pipes.forEach(p => {
    p.x -= pipeSpeed;
    if (bird.x < p.x + p.width && bird.x + bird.width > p.x && (bird.y < p.top || bird.y + bird.height > canvas.height - p.bottom)) endGame();
    if (!p.passed && p.x + p.width < bird.x) { p.passed = true; score++; coins++; updateLevel(); updateScore(); }
  });
  pipes = pipes.filter(p => p.x + p.width > 0);
  if (frame % 120 === 0) createPipe();
}

function updateLevel() {
  let newLevel = Math.floor(score / 10) + 1;
  if (newLevel > level) { level = newLevel; pipeSpeed += 0.5; pipeGap -= 5; if (pipeGap < 100) pipeGap = 100; }
}

function endGame() {
  if (!gameOver) hitSound.play();
  gameOver = true;
  ctx.fillStyle = "rgba(0,0,0,0.6)";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = "white";
  ctx.font = "28px Arial";
  ctx.fillText("Game Over", 120, 280);
}

function gameLoop() {
  if (gameOver) return;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  drawBird();
  updateBird();
  drawPipes();
  updatePipes();
  frame++;
  requestAnimationFrame(gameLoop);
}

function flap() { if (!gameOver) { bird.velocity = bird.lift; flySound.play(); } }

canvas.addEventListener("click", flap);
canvas.addEventListener("touchstart", flap);
restartBtn.addEventListener("click", () => { ctx.clearRect(0,0,canvas.width,canvas.height); init(); requestAnimationFrame(gameLoop); });

// المتجر
storeBtn.addEventListener("click", () => { storeDiv.style.display = "block"; });
closeStoreBtn.addEventListener("click", () => { storeDiv.style.display = "none"; });
function renderStore() {
  charactersDiv.innerHTML = "";
  characterList.forEach((char, index) => {
    const img = document.createElement("img");
    img.src = char.src;
    img.title = `${char.name} - ${char.price} Coins - Unlock Level: ${char.unlockLevel}`;
    img.addEventListener("click", () => buyCharacter(index));
    charactersDiv.appendChild(img);
  });
}
function buyCharacter(index) {
  const char = characterList[index];
  if(level < char.unlockLevel){ alert(`هذه الشخصية ستفتح عند Level ${char.unlockLevel}`); return; }
  if(coins >= char.price){ coins -= char.price; birdImg.src = char.src; alert(`${char.name} تم شراؤها!`); updateScore(); }
  else if(char.price===0){ birdImg.src = char.src; alert(`${char.name} تم اختيارها!`); }
  else alert(`لا يوجد لديك Coins كافية! تحتاج ${char.price} Coins`);
}

// زر Play
playBtn.addEventListener("click", () => {
  startScreen.style.display = "none";
  gameUI.style.display = "block";
  init();
  requestAnimationFrame(gameLoop);
});
